# システムトレード システム要件書

本リポジトリの戦略・コード・マケデコDiscordの実運用知見に基づく、
日本株システムトレードに必要なシステム要件の整理。

---

## 1. 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    システムトレード全体構成                 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  [データ取得層]                                           │
│    J-Quants API / yfinance / DataGet2 / タワースコープ     │
│         │                                               │
│         ▼                                               │
│  [データ蓄積層]                                           │
│    PostgreSQL / SQLite / BigQuery / CSV                   │
│         │                                               │
│         ▼                                               │
│  [分析・シグナル生成層]                                     │
│    Python (pandas/numpy/scipy/sklearn)                    │
│    戦略ロジック / テクニカル指標 / ML モデル                  │
│         │                                               │
│         ▼                                               │
│  [バックテスト層]                                          │
│    自作フレームワーク / backtrader / vectorbt              │
│         │                                               │
│         ▼                                               │
│  [発注層]                                                │
│    証券会社API (立花証券e支店 / カブコム / 楽天 / 岡三)      │
│         │                                               │
│         ▼                                               │
│  [監視・ログ層]                                           │
│    Grafana / Slack通知 / ログファイル                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 証券会社API

システムトレードの発注を行うためのAPI選定。OS要件が最大の分岐点となる。

### 比較表

| 証券会社 | OS要件 | クラウド対応 | 特記事項 |
|---------|--------|------------|---------|
| **立花証券e支店API** | Linux/Docker可 | GCP/AWS対応 | HTTPS+JSON API。クラウドデプロイ可能。**Linux環境では最有力** |
| **三菱UFJ eスマート証券API（旧カブコム）** | Windows必須 | Windows VPS | kabuステーション経由（REST API）。デイトレ信用金利0%。2025年5月～二要素認証強化 |
| **楽天RSS** | Windows必須 | Windows VPS | マーケットスピード起動必須 |
| **岡三RSS** | Windows必須 | Windows VPS | 岡三ネットトレーダー起動必須 |

### 推奨構成

- **Linux/Docker環境を前提とする場合**: 立花証券e支店API
- **Windows環境を許容する場合**: 三菱UFJ eスマート証券API（旧カブコム。デイトレ信用金利0%のメリット）

### 認証の自動化（2025年以降必須）

各証券会社が2段階認証を義務化しており、自動売買には認証自動化が必須。

| 証券会社 | 認証方式 | 自動化手法 |
|---------|---------|-----------|
| 三菱UFJ eスマート証券（旧カブコム） | 二要素認証（2025年5月27日～段階的強化、kabuステーションは6月16日～） | メールOTP or 認証アプリ。IMAP受信 → 正規表現で認証コード抽出 → 自動入力。Gmail API or S3転送も可。メール到着が5分の有効期限内に来ないリスクあり |
| 立花証券 | 電話番号認証（2025年7月26日～） | 登録電話番号からの発信認証。Twilio (050番号) → Python SIPで自動発信 |

---

## 3. データ取得

### 過去データ（バックテスト用）

| データソース | データ粒度 | コスト | 備考 |
|------------|----------|--------|------|
| **J-Quants API** | 日足（基本） | 無料～プレミアム | プレミアムプランで前場後場の価格データ取得可。JPX公式 |
| **yfinance** | 日足 / 分足（過去数日分） | 無料 | 日本株データは一部欠損あり。バックテスト用としては注意が必要 |
| **DataGet2** | 1分足 | 有料 | API経由。5分足はリサンプリングで作成 |
| **タワースコープ** | 1分足 | 有料 | Web API。全銘柄を60秒に1回リクエスト可能 |

### データ管理の注意事項

- **銘柄コードの文字列対応**: 2024年1月以降、Tokyo Pro Marketで英字を含む銘柄コード（132A等）が登場。整数前提の処理は要修正
  ```python
  # フィルタリング例
  pd.to_numeric(df['Code'], errors='coerce').notnull()
  ```

---

## 4. 実行環境

### 4-1. バックテスト・研究環境

研究・開発フェーズでは計算リソースが必要。GPUは機械学習モデル訓練時のみ。

| 環境 | コスト目安 | 用途 | 注意点 |
|------|----------|------|--------|
| **Google Colab** | 無料～月額1,179円 | Notebook分析、軽量ML | 学習1回で1ヶ月分のクレジット消費のケースあり。ロケーション不定でGCS転送コスト発生（3-400円/回） |
| **GCPスポットインスタンス** | 従量課金 | ML学習、大規模バックテスト | Colabより低コスト。ライブラリのバージョン管理が厳密に可能 |
| **Google Batch** | 従量課金 | コンテナ化バッチジョブ | 大量銘柄の一括バックテストに最適 |
| **Vertex AI Workbench** | 従量課金 | フルマネージドNotebook | Notebook作業に適する |
| **ローカルPC** | 初期投資のみ | 開発、軽量バックテスト | GPU搭載PCならML学習も可能 |

### 4-2. 本番運用環境

自動売買を24/5で稼働させるためのインフラ。

| 環境 | コスト目安 | 用途 | 備考 |
|------|----------|------|------|
| **AWS t3.small (Windows)** | 月30USD（休日停止で10USD未満） | カブコム/楽天/岡三 | Windows VPS。休日停止でコスト最適化 |
| **GCP e2-micro (Linux)** | 無料枠～月数USD | 立花証券e支店 | Docker対応。最もコスト効率が良い |
| **自宅サーバー** | 電気代のみ | 全般 | ネットワーク障害リスクあり |

### コスト最適化のポイント

- GCPはロケーション固定でデータ転送費を削減
- GPUはプリエンプティブル/スポット選択でコスト削減
- Windows Serverは休日停止で大幅なコスト削減可能

---

## 5. Python環境・ライブラリ

### 必須ライブラリ

```
# データ処理・分析
pandas>=2.0
numpy>=1.24
scipy>=1.10

# 株価データ取得
yfinance>=0.2.18

# 可視化
matplotlib>=3.7

# 機械学習（戦略に応じて）
scikit-learn>=1.2
```

### 戦略別の追加ライブラリ

| 戦略カテゴリ | 追加ライブラリ | 用途 |
|------------|-------------|------|
| テクニカル分析（EMA/ATR/MACD等） | `ta-lib` or 自作 | テクニカル指標計算 |
| 機械学習ベース | `lightgbm`, `xgboost`, `catboost` | 勾配ブースティング |
| ディープラーニング | `torch` or `tensorflow` | LSTM, Transformer |
| NLPセンチメント分析 | `transformers`, `fugashi`, `ipadic` | 日本語BERT系モデル（※FinBERTは英語専用。日本語にはFinDeBERTaV2等を使用） |
| LLMベース戦略 | `openai` or `anthropic` | LLM API呼び出し |
| バックテストFW | `backtrader`, `vectorbt` | 汎用バックテストフレームワーク |
| 統計分析 | `statsmodels` | 共和分検定（ペアトレード）等 |

### Python バージョン

- **Python 3.12以上**を推奨（3.10はセキュリティ修正のみ、2026年10月EOL予定。3.13/3.14が安定版）

---

## 6. データベース設計

### 最低限必要なテーブル構成

```
[prices]         日次/分次の価格データ (OHLCV)
[signals]        戦略が生成したシグナル
[orders]         発注記録
[executions]     約定記録
[positions]      現在のポジション状態
[portfolio]      資産推移・パフォーマンス指標
```

### 推奨DB

| 用途 | 推奨 | 理由 |
|------|------|------|
| ローカル開発 | **SQLite** | セットアップ不要、ファイル1つ |
| 本番運用 | **PostgreSQL** | 時系列拡張（TimescaleDB）対応、堅牢 |
| 大規模分析 | **BigQuery** | 全銘柄×長期間の分析に適する |

---

## 7. 監視・アラート

### 最低限の監視項目

| 項目 | 頻度 | アラート条件 |
|------|------|------------|
| システム死活 | 1分毎 | プロセスダウン |
| API接続状態 | 5分毎 | 認証切れ、接続エラー |
| ポジション状態 | リアルタイム | 未決済ポジションの異常増加 |
| 日次損益 | 日次 | ドローダウン閾値超過 |
| 戦略パフォーマンス | 週次/月次 | シャープレシオ悪化、勝率低下 |

### 通知手段

- **Slack Webhook**: 最も手軽。PythonからHTTP POSTのみで実装可能
- **LINE Notify**: 個人利用に適する（2025年3月にサービス終了→LINE Messaging API移行）
- **メール**: SMTP経由。緊急度の高い通知向け

### ダッシュボード

- **Grafana**: オープンソース。J-Quants API連携のニーズが高い
- **Connected Sheet / Looker Studio**: 無料で統計処理や線形回帰が可能

---

## 8. 運用フロー（日次）

```
06:00  データ更新バッチ起動（前日終値取得・指標再計算）
08:00  証券会社APIログイン・認証自動化
08:20  プレマーケット分析（銘柄スクリーニング、シグナル生成）
09:00  前場開始 → シグナルに基づく自動発注
       ├── 30秒~1分間隔で株価ポーリング
       ├── SL/TPの監視・執行
       └── ポジション管理
11:30  前場終了
12:30  後場開始 → 同上
15:00  後場終了
15:30  日次集計バッチ（約定記録、損益計算、パフォーマンス更新）
       Slack/メールで日次レポート送信
```

---

## 9. セキュリティ要件

| 項目 | 要件 |
|------|------|
| APIキー管理 | 環境変数 or Secrets Manager（.envファイルはgitignore必須） |
| 証券会社認証情報 | 暗号化ストレージ。コードにハードコードしない |
| 通信 | HTTPS/TLS必須 |
| サーバーアクセス | SSH鍵認証のみ。パスワード認証無効化 |
| ログ | 約定記録は改竄不可能な形式で保存（税務対応） |
| バックアップ | DB・設定ファイルの日次バックアップ |

---

## 10. 段階的な構築ロードマップ

### Phase 1: バックテスト環境（1-2週間）

```
必要なもの:
  - Python 3.10+
  - pandas, numpy, yfinance, matplotlib
  - 本リポジトリのバックテストコード
  - Google Colab or ローカルPC

成果物:
  - 戦略のバックテスト結果
  - パラメータの初期選定
```

### Phase 2: データ基盤構築（2-4週間）

```
必要なもの:
  - J-Quants API アカウント
  - SQLite or PostgreSQL
  - データ取得・蓄積バッチスクリプト

成果物:
  - 日次自動データ更新パイプライン
  - 過去データの蓄積
```

### Phase 3: ペーパートレード（1-3ヶ月）

```
必要なもの:
  - 証券会社API アカウント
  - クラウドサーバー（GCP or AWS）
  - Slack通知設定

成果物:
  - 実市場データでのシグナル検証（発注はしない）
  - シグナル精度の検証
  - システム安定性の確認
```

### Phase 4: 小額実運用（3ヶ月～）

```
必要なもの:
  - 証券口座（実資金）
  - 認証自動化の実装
  - 監視・アラートシステム
  - リスク管理ルール（1トレードあたり資金の2%以内等）

成果物:
  - 実運用パフォーマンスデータ
  - バックテストとの乖離分析
```

---

## 11. 参照情報

- マケデコ Discord #システム構築チャンネル（2022年9月～2025年9月の実運用知見）
- 本リポジトリ内のバックテストコード（`20260214/`, `20260227/`）
- J-Quants API: https://jpx-jquants.com/
- 立花証券e支店API: https://www.e-shiten.jp/
- 三菱UFJ eスマート証券API（旧カブコム）: https://kabu.com/
